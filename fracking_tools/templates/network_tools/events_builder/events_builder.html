<!doctype html>
<html lang="en">
  <head>
    {% load static %}
    <title>Fracking Tools: Build Events from Files</title>
    {% include 'ftglobal/head.html' %}
  </head>
  <body>
    {% include 'ftglobal/navbar.html' %}
    <div id="wrapper">
      <div id="header">
        {% include 'network_tools/events_builder/jumbotron.html' %}        
      </div>
      <div id="content">
        <div class="container text-center">
          <div id="msg-holder"></div>
          {% include 'network_tools/read_docs.html' %}
          <div class="collapsed" id="steps-collapse">
            <form action="{% url 'network_tools:build_events_now' %}" method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <div id="holder" class="mt-4"></div>
              {% include 'network_tools/events_builder/steps.html' %}
            </form>
          </div>
        </div>
      </div>
      <div id="footer">
        {% include 'ftglobal/footer.html' %}
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

    <!-- NECESSARY FOR FILE SAVING -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.js"></script>

    <!-- Main JS Code -->
    <script src="{% static 'ftglobal/js/main.js' %}" charset="utf-8"></script>
    <script src="{% static 'ftglobal/js/misc.js' %}" charset="utf-8"></script>
    
    <script>
    {% if request.GET.task %}
      let interval = 10; 
      let intervalId; 

      $(document).ready(function(){
          window.scrollTo(0,document.body.scrollHeight);
          setTimeout(checkTaskStatus, 0); 
          intervalId = setInterval(checkTaskStatus, interval); 
      });

      function checkTaskStatus() {
        $.ajax({
          url: "{% url 'network_tools:check_task_status' %}",
          data: {'task-id': '{{ request.GET.task }}'},
          dataType: 'json',
          success: statusCheck
        }); 
      }

      function statusCheck(data) {
        console.log(data.status); 
        if (data.status == 'SUCCESS') {
          clearInterval(intervalId); 
          
          $('#btn-content').html(
            `<button type="submit" id="build-matrices-btn" class="btn btn-dark btn-block disabled" name="button" disabled> 
              Finished <i class="fas fa-check"></i>
            </button>`
          ); 
          downloadEvents(); 

          setTimeout(resetEventsBuilder, 3000); 
        }
      }
      
      function resetEventsBuilder() {
        window.location.replace("{% url 'network_tools:build_events' %}");
      }

      function downloadEvents() {
        window.location.replace("{% url 'network_tools:download_events' %}?task={{ request.GET.task }}&csv={{ request.GET.csv }}");
      }

    {% endif %}
    </script>
  </body>
</html>
